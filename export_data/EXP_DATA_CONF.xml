<?xml version="1.0" encoding="utf-8"?>
<Beging>
    <EXCEL EXCEL_NAME="业绩报表检查" EMAIL_ADD="jin.zhang@ccb-life.com.cn,kang.lin@ccb-life.com.cn" >
        <SQL sheet_name="承保">select *
  from (select issueway2,
               count(distinct polno) 承保量,
               sum(transamnt) 承保保费,
               count(distinct h.contno) 预约投保量,
               nvl(sum(h.prem), 0) 预约投保金额
          from (select (case
                         when t1.bankcode = '05' and t1.issueway = '1' then
                          '建行柜台'
                         when t1.bankcode = '05' and t1.issueway = '2' then
                          '建行网银'
                         when t1.bankcode = '05' and t1.issueway = '3' then
                          '建行手机银行'
                         when t1.bankcode = '05' and t1.issueway = '4' then
                          '建行自助终端'
                         when t1.bankcode = '05' and t1.issueway = '7' then
                          '建行智慧柜员机'
                         when t1.bankcode = '05' and t1.issueway = '2' then
                          '建行网银'
                         when t1.bankcode = '08' and t1.issueway = '2' then
                          '中信银行网银'
                         when t1.bankcode = '08' and t1.issueway = '3' then
                          '中信银行手机'
                         when lc.selltypedetail = '800' then
                          '电商官网'
                         when lc.selltypedetail = '811' then
                          '电商微信'
                         when lc.selltypedetail in ('808', '812') then
                          '电商悦生活'
                         else
                          '其他银行'
                       END) issueway2,
                       case
                         when c.contno is null then
                          t1.polno
                       end as polno,
                       case
                         when c.contno is null then
                          t1.transamnt
                       end as transamnt,
                       t1.transdate transdate,
                       c.contno contno,
                       case
                         when c.contno is not null then
                          lc.prem
                       end as prem
                  from lis.lktransstatus t1, lis.lccont lc
                  left join lis.lcsubcont c
                    on lc.contno = c.contno
                 where t1.transdate =
                       to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
                   and t1.funcflag = 'OPR011'
                   and t1.polno = lc.contno
                   and not exists (select *
                          from lis.lktransstatus t2
                         where t2.polno = t1.polno
                           and funcflag = 'OPR911')
                   and status = '1') h
         group by issueway2
        union all
        select '团保通' 子渠道,
               count(a.prtno) 承保量,
               sum(lj.sumactupaymoney) 承保保费,
               0,
               0
          from gcs.lcgrpcont a, gcs.ljapay lj
         where lj.incomeno = a.grpcontno
           and lj.incometype = '1'
           and a.salechnl = '09'
           and a.salechnldetail = '10'
           and a.appflag = '1'
           and a.makedate =
               to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
        union all
        select '个险手工单承保' 子渠道,
               count(*) 承保量,
               sum(prem) 承保保费,
               0,
               0
          from lis.lccont lc
         where exists (select 'x'
                  from lis.lwmission a
                 where missionprop1 = prtno
                   and a.activityid = '0000001150')
           and lc.firsttrialdate =
               to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and ((salechnl in ('1', '3') and selltype &lt;&gt; '12'))
           and policygettype is null
        union all
        select '团险手工单承保' 子渠道,
               count(a.grpcontno) 承保量,
               sum(lj.sumactupaymoney) 承保保费,
               0,
               0
          from gcs.lcgrpcont a, gcs.ljapay lj
         where lj.incomeno = a.grpcontno
           and a.signdate =
               to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
           and a.grpcontno not in
               (select grpcontno
                  from gcs.lcgrpcont lc
                 where ((lc.salechnl = '09' and lc.salechnldetail = '10') or
                       (lc.salechnl = '01' and lc.salechnldetail = '10'))
                   and lc.signdate =
                       to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd'))
        union all
        select '健康险手工单承保' 子渠道,
               count(*) 承保量,
               sum(prem) 承保保费,
               0,
               0
          from his.lccont
         where cvalidate =
               to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and appflag = '1'
           AND (SELLTYPEDETAIL IS NULL OR SELLTYPEDETAIL NOT IN ('301', '307'))
        union all
        select '建信E保承保' 子渠道,
               count(*) 承保量,
               sum(prem) 承保保费,
               0,
               0
          from lis.lccont lc
         where lc.polapplydate =
               to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and policygettype = '1')</SQL>
		   <SQL sheet_name="退保">select *
  from (select issueway2 子渠道,
               count(distinct polno) 退保量,
               sum(-getmoney) 退保保费
          from (select (case
                         when t1.bankcode = '05' and t1.issueway = '1' then
                          '建行柜台'
                         when t1.bankcode = '05' and t1.issueway = '2' then
                          '建行网银'
                         when t1.bankcode = '05' and t1.issueway = '3' then
                          '建行手机银行'
                         when t1.bankcode = '05' and t1.issueway = '4' then
                          '建行自助终端'
                         when t1.bankcode = '05' and t1.issueway = '7' then
                          '建行智慧柜员机'
                         when t1.bankcode = '05' and t1.issueway = '2' then
                          '建行网银'
                         when t1.bankcode = '08' and t1.issueway = '2' then
                          '中信银行网银'
                         when t1.bankcode = '08' and t1.issueway = '3' then
                          '中信银行手机'
                         when t1.bankcode = '18' then
                          '电商'
                         else
                          '其他银行'
                       END) issueway2,
                       t1.polno polno,
                       transamnt,
                       p.getmoney,
                       p.hesitateflag,
                       t1.transdate transdate
                  from lis.lktransstatus t1, lis.lpedoritem p
                 where t1.transdate =
                       to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
                   and t1.funcflag in ('34', 'OPR012')
                   and t1.polno = p.contno
                   and p.edortype = 'CT'
                   and t1.status = '1') h
         group by transdate, issueway2
        union all
        select '个险核心手工退保' 子渠道,
               count(distinct a.contno) 退保量,
               sum(-b.getmoney) 退保保费
          from lis.lccont a, lis.LPEDORITEM b, lis.lpedorapp c
         where a.contno = b.CONTNO
           and b.edoracceptno = c.edoracceptno
           and b.edortype = 'CT'
           AND b.edorstate in ('0', '2')
           and b.edorappdate =
               to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and (decode(b.standbyflag2,
                       'CallCenter',
                       decode(b.operator, 'CCIVR', 'IVR', '电话中心'),
                       'BJS',
                       'BJS',
                       'EC',
                       decode(b.edortype,
                              'BM',
                              'IVR',
                              'AP',
                              'IVR',
                              'BX',
                              'IVR',
                              '官网'),
                       decode(c.apptype,
                              '12',
                              '电子保全',
                              '13',
                              '电子保全',
                              decode(b.operator,
                                     'EBIZ',
                                     '官网',
                                     'esbservice',
                                     '官网',
                                     'YBT0000001',
                                     '新一代',
                                     'CCB',
                                     '新一代',
                                     '人工方式')))) = '人工方式'
        union all
        select '团险核心手工退保' 子渠道,
               count(distinct b.contno) 退保量,
               sum(-b.getmoney) 退保保费
          from gcs.lbcont a, gcs.lpedoritem b
         where a.grpcontno = b.grpcontno
           and a.contno = b.contno
           and b.edortype in ('CT', 'ZT')
           AND b.edorstate = '0'
           and b.edorappdate =
               to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
        union all
        select *  from (WITH BASE_CONT AS
 (SELECT '' EDORNO, CONTNO, CONTSTATE, MODIFYDATE
    FROM HIS.LCCONT
   WHERE SUBSTR(CONTSTATE, 0, 1) = '3'
     AND STATEFLAG = '3'
  UNION
  SELECT EDORNO, CONTNO, CONTSTATE, MODIFYDATE
    FROM HIS.LBCONT
   WHERE SUBSTR(CONTSTATE, 0, 1) = '3'
     AND STATEFLAG = ANY('3', '6', '7'))
SELECT        '健康险核心退保' 子渠道,
       COUNT(1) 总量,
       SUM(SUMGETMONEY) 总金额
  FROM (
        --解除合同/转出终止
        SELECT LP.EDORVALIDATE ENDDATE, ABS(LP.GETMONEY) SUMGETMONEY
          FROM BASE_CONT LC, HIS.LPEDORITEM LP
         WHERE LP.EDORTYPE = ANY('CT', 'ZC', 'DB')
           AND LC.CONTNO = LP.CONTNO
           AND LC.CONTSTATE = ANY('304', '311')
           AND LP.MODIFYDATE =
               TO_DATE(TO_CHAR(SYSDATE, 'yyyyMMdd'), 'yyyy-MM-dd')
        --理赔终止
        UNION
        SELECT LS.ENDCASEDATE ENDDATE,
                NVL((SELECT LA.SUMGETMONEY
                      FROM HIS.LJAGET LA
                     WHERE OTHERNO = LL.CASENO),
                    0) SUMGETMONEY
          FROM BASE_CONT LC, HIS.LLCLAIM LL, HIS.LLCASE LS
         WHERE (LC.EDORNO = LL.CASENO OR LC.EDORNO = LL.CLMNO)
           AND LS.CASENO = LL.CASENO
           AND LS.MODIFYDATE =
               TO_DATE(TO_CHAR(SYSDATE, 'yyyyMMdd'), 'yyyy-MM-dd')
        --失效终止/满期终止
        UNION
        SELECT LT.STARTDATE ENDDATE,
                NVL((SELECT LA.SUMGETMONEY
                      FROM HIS.LJAGET LA
                     WHERE OTHERNO = LC.CONTNO),
                    0) SUMGETMONEY
          FROM BASE_CONT LC, HIS.LCCONTSTATE LT
         WHERE CONTSTATE = ANY('302', '305')
           AND LC.CONTNO = LT.CONTNO
           AND LT.POLNO = '000000'
           AND LT.STATETYPE = 'Terminate'
           AND LT.MODIFYDATE =
               TO_DATE(TO_CHAR(SYSDATE, 'yyyyMMdd'), 'yyyy-MM-dd')))
        union all
        select '建信E保退保' 子渠道,
               count(*) 退保总量,
               abs(sum(a.getmoney)) 退保总金额
          from lis.lpedoritem a
         where edortype = 'CT'
           and a.edorstate in ('0', '2')
           and a.edorappdate =
               to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and edoracceptno in
               (select edoracceptno
                  from lis.lpedorapp
                 where edoracceptno = a.edoracceptno
                   and apptype in ('12', '13'))
        union all
        select '保交所退保' 子渠道,
               count(*) 退保总量,
               abs(sum(a.getmoney)) 退保总金额
          from lis.lpedoritem a
         where edortype = 'CT'
           and a.edorstate in ('0', '2')
           and a.edorappdate =
               to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and a.standbyflag2 = 'BJS')</SQL>
		<SQL sheet_name="总量">select transdate 交易日期, issueway2 子渠道,count(*) 交易总量
  from (select transdate transdate,
               transcode transcode,
               (case
                 when bankcode = '05' and t1.issueway = '1'
                                 and funcflag not like 'G%' then
                  '建行柜台'
                 when bankcode = '05' and t1.issueway = '2' then
                  '建行网银'
                 when bankcode = '05' and t1.issueway = '3' then
                  '建行手机银行'
                 when bankcode = '05' and t1.issueway = '4' then
                  '建行自助终端'
                 when bankcode = '05' and t1.issueway = '7' then
                  '建行智慧柜员机'
                 when bankcode = '05' and t1.issueway = '2' then
                  '建行网银'
                 when bankcode = '08' and t1.issueway = '2' then
                  '中信银行网银'
                 when bankcode = '08' and t1.issueway = '3' then
                  '中信银行手机'
                 when funcflag like 'G%' then
                  '团保通'
                 when bankcode = '18' then
                  '电商'
                 when bankcode = '00' then
                  '建信E保'
                 else
                  '其他建行'
               END) issueway2
          from utp.yktransstatus t1
         where transdate = to_date(to_char(sysdate, 'yyyyMMdd'), 'yyyy-MM-dd')
           and funcflag not in ('58', '41', 'GREEN001', 'G71', '90'))
 group by transdate,issueway2</SQL>
    </EXCEL>
</Beging>
